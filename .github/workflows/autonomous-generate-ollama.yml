name: Autonomous Article Generation (Ollama)

on:
  schedule:
    # Run every 4 hours
    - cron: '0 */4 * * *'
  workflow_dispatch:
    # Manual trigger for testing

permissions:
  contents: write

jobs:
  generate-article:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Ollama
        run: |
          echo "üì¶ Installing Ollama..."
          curl -fsSL https://ollama.ai/install.sh | sh
          which ollama
          echo "‚úÖ Ollama installed"

      - name: Install Python dependencies (before Ollama)
        run: |
          pip install --no-cache-dir gray-matter

      - name: Start Ollama service
        run: |
          echo "üöÄ Starting Ollama service..."
          # Start ollama in background with output redirected
          nohup ollama serve > /tmp/ollama.log 2>&1 &
          OLLAMA_PID=$!
          echo "Ollama PID: $OLLAMA_PID"
          
          # Wait for service to be ready (longer timeout)
          for i in {1..60}; do
            if curl -s http://localhost:11434/api/tags > /dev/null 2>&1; then
              echo "‚úÖ Ollama service ready"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "‚ùå Ollama failed to start"
              cat /tmp/ollama.log
              exit 1
            fi
            echo "‚è≥ Waiting for Ollama... ($i/60)"
            sleep 1
          done

      - name: Pull Ollama model
        run: |
          echo "üì• Pulling model (neural-chat)..."
          timeout 600 ollama pull neural-chat:latest || timeout 600 ollama pull mistral || ollama pull tinyllama
          echo "‚úÖ Model ready"
          ollama list

      - name: Generate topic history
        run: |
          echo "üìö Building topic history..."
          node scripts/build-topic-history.js
          echo "‚úÖ Topic history built"
        continue-on-error: true

      - name: Select topic
        id: topic
        run: |
          echo "üéØ Selecting topic..."
          node scripts/topic-selector.js > selected-topic.json
          TOPIC=$(node -e "console.log(JSON.parse(require('fs').readFileSync('selected-topic.json')).topic)")
          echo "topic=$TOPIC" >> $GITHUB_OUTPUT
          echo "‚úÖ Selected topic: $TOPIC"

      - name: Generate article with Ollama
        env:
          OLLAMA_MODEL: mistral
          OLLAMA_BASE_URL: http://localhost:11434
        run: |
          echo "‚úçÔ∏è  Generating article with Ollama..."
          python scripts/generate_article_agentic.py
          echo "‚úÖ Article generation complete"

      - name: Configure Git
        run: |
          git config --global user.name 'autonomousBLOG Bot'
          git config --global user.email 'autonomousblog@github-actions.local'

      - name: Commit and push article (prevent recursive trigger)
        run: |
          git add articles/
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
            exit 0
          fi
          
          # Use [skip ci] to prevent deployment workflow from re-triggering generation
          git commit -m "ü§ñ Auto-generated article: $(date -u +%Y-%m-%d) [skip ci]"
          
          if git push origin main; then
            echo "‚úÖ Article committed and pushed"
          else
            echo "‚ö†Ô∏è  Push failed (may need to pull first)"
            git pull --rebase origin main
            git push origin main
          fi

      - name: Build article index
        run: |
          echo "üî® Building article index..."
          node scripts/build-article-index.js
          echo "‚úÖ Article index built"
        continue-on-error: true

      - name: Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          cname: false
          allow_empty_commit: true

      - name: Show summary
        if: always()
        run: |
          echo "üìä Workflow Summary:"
          echo "   Article topic: ${{ steps.topic.outputs.topic }}"
          echo "   Model: mistral"
          echo "   Status: Complete"
