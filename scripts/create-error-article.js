#!/usr/bin/env node

/**
 * Create Error Report Article
 * Converts any failure into a detailed blog post for documentation and debugging
 * "Failures as Features" - make all errors visible and trackable
 */

const fs = require('fs');
const path = require('path');

const ARTICLES_DIR = path.join(__dirname, '..', 'articles');

function generateSlug(title) {
  return title
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/(^-|-$)/g, '');
}

function generateDatePath() {
  const now = new Date();
  const year = String(now.getFullYear());
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return path.join(year, month, day);
}

function extractErrorType(logContent) {
  if (logContent.includes('ECONNREFUSED')) return 'Connection Error';
  if (logContent.includes('timeout')) return 'Timeout Error';
  if (logContent.includes('ENOENT')) return 'File Not Found';
  if (logContent.includes('JSON')) return 'JSON Parse Error';
  if (logContent.includes('GEMINI') || logContent.includes('Gemini')) return 'Gemini API Error';
  if (logContent.includes('Ollama')) return 'Ollama Error';
  if (logContent.includes('404')) return 'Not Found Error';
  if (logContent.includes('403')) return 'Permission Error';
  if (logContent.includes('500')) return 'Server Error';
  return 'Generation Error';
}

function getErrorTheme(errorType) {
  const themes = {
    'Connection Error': 'neon-nights',
    'Timeout Error': 'matrix-code',
    'File Not Found': 'industrial',
    'JSON Parse Error': 'paper-ink',
    'Gemini API Error': 'forest-calm',
    'Ollama Error': 'ocean-breeze',
    'Not Found Error': 'cotton-candy',
    'Permission Error': 'sunset-vibes',
    'Server Error': 'aurora',
    'Generation Error': 'neon-nights'
  };
  return themes[errorType] || 'neon-nights';
}

function createErrorArticle(logContent, exitCode, processName = 'Article Generation') {
  const now = new Date();
  const errorType = extractErrorType(logContent);
  const theme = getErrorTheme(errorType);
  
  const title = `âš ï¸ System Incident: ${errorType}`;
  const slug = generateSlug(title);
  
  // Parse log for better formatting
  const logLines = logContent.split('\n').slice(0, 50); // Keep first 50 lines
  const formattedLog = logLines.map(line => {
    if (line.includes('Error') || line.includes('ERROR')) {
      return `**${line}**`;
    }
    return line;
  }).join('\n');

  const errorContent = `---
title: "${title}"
date: "${now.toISOString()}"
theme: "${theme}"
topic: "System Incident Report"
contentType: "incident-report"
generated: "failure-handler"
excerpt: "A system incident occurred during ${processName}. This is an automated incident report documenting what went wrong."
---

# ${title}

**Incident Type**: ${errorType}  
**Process**: ${processName}  
**Timestamp**: ${now.toUTCString()}  
**Exit Code**: ${exitCode}  
**Status**: ğŸ”´ Failed

## Incident Summary

The autonomous blog system encountered an error during ${processName}. Rather than failing silently, this incident has been recorded as a blog post for transparency and debugging.

## Error Details

\`\`\`
${formattedLog}
\`\`\`

## What We Know

- **Error Type**: ${errorType}
- **Time**: ${now.toLocaleString()}
- **Process**: ${processName}
- **System**: autonomousBLOG (Automated)

## Analysis & Investigation

This error indicates one of the following:

1. **Configuration Issue**: Environment variables or secrets might be misconfigured
2. **Service Unavailable**: External service (Ollama, API) might be down
3. **Resource Constraint**: System might be out of memory or disk space
4. **Network Problem**: Connectivity issue to external services
5. **Code Bug**: Logic error in the generation process

## Recommended Actions

### For Developers:
1. Check the full error log in GitHub Actions
2. Verify all environment variables are set correctly
3. Test the failing process locally
4. Review recent code changes
5. Check external service status (Ollama, APIs, etc.)

### For DevOps:
1. Verify services are running and accessible
2. Check system resources (CPU, memory, disk)
3. Review firewall and network rules
4. Check service logs for more details
5. Restart services if necessary

## Timeline

| Time | Event |
|------|-------|
| ${now.toISOString()} | Incident occurred |
| ${new Date(Date.now() + 1000).toISOString()} | Error logged and article created |

## System Health

- **Last Successful Run**: Check GitHub Actions history
- **Current Status**: ğŸ”´ Error
- **Auto-Recovery**: Will retry on next scheduled run

---

*This article was automatically generated by autonomousBLOG's incident reporting system.*  
*Failures as Features: Making errors visible and actionable.*

> **Note**: This incident report is visible to all. Review and fix the underlying issue to prevent recurrence.
`;

  const datePath = generateDatePath();
  const articleDir = path.join(ARTICLES_DIR, datePath);
  const articleFile = path.join(articleDir, `${slug}.md`);

  // Ensure directory exists
  fs.mkdirSync(articleDir, { recursive: true });

  // Write article
  fs.writeFileSync(articleFile, errorContent);
  
  console.log('');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('ğŸ“° INCIDENT REPORT CREATED');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log(`Title: ${title}`);
  console.log(`File: ${articleFile}`);
  console.log(`Theme: ${theme}`);
  console.log('');
  console.log('This incident will be published as a blog post.');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('');
  
  return articleFile;
}

// Main execution
const logContent = process.argv[2] || 'No log content provided';
const exitCode = process.argv[3] || '1';
const processName = process.argv[4] || 'Article Generation';

try {
  createErrorArticle(logContent, exitCode, processName);
} catch (error) {
  console.error('Failed to create error article:', error.message);
  process.exit(1);
}
